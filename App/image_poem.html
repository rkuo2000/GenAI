<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 影像作詩系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #preview-canvas { display: none; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">AI 影像作詩系統</h1>
            <p class="text-gray-600">上傳照片或拍攝，讓 AI 為您賦詩一首</p>
        </header>

        <!-- 設定區域 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Google Gemini API Key</label>
            <input type="password" id="apiKey" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="在此輸入您的 API Key">
            <p class="text-xs text-gray-400 mt-1">您的 Key 僅供瀏覽器端呼叫，不會被儲存。</p>
        </div>

        <!-- 輸入控制區 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button onclick="triggerUpload()" class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-indigo-500 transition">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span class="mt-2 text-sm">上傳照片</span>
                </button>
                <button onclick="startWebcam()" class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-indigo-500 transition">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="mt-2 text-sm">即時拍攝</span>
                </button>
            </div>

            <!-- Webcam 容器 (預設隱藏) -->
            <div id="webcam-container" class="hidden relative mb-4">
                <video id="video" autoplay playsinline class="w-full rounded-lg bg-black"></video>
                <button onclick="capturePhoto()" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-red-600">拍照</button>
            </div>

            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
            
            <!-- 預覽圖 -->
            <div id="preview-wrapper" class="hidden">
                <img id="image-preview" class="w-full rounded-lg shadow-sm mb-4">
                <button id="generate-btn" onclick="generatePoem()" class="w-full gradient-bg text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition disabled:opacity-50">
                    AI 辨識並作詩
                </button>
            </div>
        </div>

        <!-- 結果顯示區 -->
        <div id="result-container" class="hidden bg-white rounded-xl shadow-md p-6 text-center">
            <h3 class="text-xl font-bold mb-4">生成結果</h3>
            <canvas id="output-canvas" class="w-full rounded-lg shadow-lg mb-4"></canvas>
            <div class="flex gap-2">
                <button onclick="downloadImage()" class="flex-1 bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition">下載圖片</button>
                <button onclick="resetAll()" class="flex-1 bg-gray-200 text-gray-700 font-bold py-2 rounded-lg hover:bg-gray-300 transition">重新製作</button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loader" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p>AI 正在品味圖片中...</p>
            </div>
        </div>
    </div>

    <script>
        let selectedImageBase64 = null;

        // --- 影像輸入處理 ---

        function triggerUpload() {
            document.getElementById('fileInput').click();
            hideWebcam();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    showPreview(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        async function startWebcam() {
            const video = document.getElementById('video');
            const container = document.getElementById('webcam-container');
            container.classList.remove('hidden');
            document.getElementById('preview-wrapper').classList.add('hidden');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                video.srcObject = stream;
            } catch (err) {
                alert("無法啟動相機: " + err);
            }
        }

        function hideWebcam() {
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('webcam-container').classList.add('hidden');
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/jpeg');
            showPreview(dataUrl);
            hideWebcam();
        }

        function showPreview(dataUrl) {
            selectedImageBase64 = dataUrl;
            const img = document.getElementById('image-preview');
            img.src = dataUrl;
            document.getElementById('preview-wrapper').classList.remove('hidden');
            document.getElementById('result-container').classList.add('hidden');
        }

        // --- Gemini API 互動 ---

        async function generatePoem() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) return alert("請輸入 Gemini API Key");

            document.getElementById('loader').classList.remove('hidden');

            const base64Data = selectedImageBase64.split(',')[1];
            
            const prompt = "請仔細辨識這張圖片的內容，並根據其意境創作一首簡短優美的中文詩（約4-8句）。請直接輸出詩句內容，不要有額外的對話或解釋。";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const poemText = data.candidates[0].content.parts[0].text.trim();
                drawResult(poemText);
            } catch (error) {
                console.error(error);
                alert("產生失敗，請檢查 API Key 或網路連線");
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        // --- 合成圖片處理 ---

        function drawResult(poem) {
            const canvas = document.getElementById('output-canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // 設定畫布大小與圖片一致
                canvas.width = img.width;
                canvas.height = img.height;

                // 畫原圖
                ctx.drawImage(img, 0, 0);

                // 計算文字位置 (放在中間下方)
                const fontSize = Math.floor(canvas.width / 20);
                ctx.font = `bold ${fontSize}px "Microsoft JhengHei", sans-serif`;
                
                const lines = poem.split('\n');
                const padding = 20;
                const lineHeight = fontSize * 1.5;
                const rectHeight = (lines.length * lineHeight) + (padding * 2);
                
                // 畫半透明遮罩背景
                ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
                ctx.fillRect(0, canvas.height - rectHeight - 40, canvas.width, rectHeight + 40);

                // 寫詩句
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                lines.forEach((line, index) => {
                    const y = (canvas.height - rectHeight) + (index * lineHeight) + padding;
                    ctx.fillText(line, canvas.width / 2, y);
                });

                document.getElementById('result-container').classList.remove('hidden');
                document.getElementById('preview-wrapper').classList.add('hidden');
            };
            img.src = selectedImageBase64;
        }

        function downloadImage() {
            const canvas = document.getElementById('output-canvas');
            const link = document.createElement('a');
            link.download = 'ai-poem.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }

        function resetAll() {
            location.reload();
        }
    </script>
</body>
</html>
