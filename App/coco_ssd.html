<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç‰©ä»¶è¾¨è­˜ç³»çµ±</title>
    <!-- å¼•å…¥ Tailwind CSS (RWD) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- å¼•å…¥ COCO-SSD æ¨¡å‹ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        .loading {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        canvas { max-width: 100%; height: auto; }
        #video-preview { display: none; width: 100%; max-width: 600px; transform: scaleX(-1); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">AI ç‰©ä»¶è¾¨è­˜ç³»çµ±</h1>
        
        <!-- æ¨¡å‹è¼‰å…¥æç¤º -->
        <div id="status" class="mb-4 text-center text-blue-600 font-medium">
            <div class="loading mr-2"></div> æ­£åœ¨è¼‰å…¥ AI æ¨¡å‹ï¼Œè«‹ç¨å€™...
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ•å€ -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <button onclick="document.getElementById('file-input').click()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition">
                ğŸ“ ä¸Šå‚³ç…§ç‰‡
            </button>
            <button onclick="startWebcam()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition">
                ğŸ“· é–‹å•Ÿè¦–è¨Šé¡é ­
            </button>
            <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
        </div>

        <!-- é¡¯ç¤ºå€åŸŸ -->
        <div class="relative flex justify-center bg-gray-200 rounded-lg overflow-hidden min-h-[300px] mb-6">
            <video id="video-preview" autoplay playsinline></video>
            <canvas id="output-canvas"></canvas>
            <div id="capture-overlay" class="absolute bottom-4 hidden">
                <button onclick="captureImage()" class="bg-red-500 text-white px-6 py-2 rounded-full shadow-lg hover:bg-red-600">æ‹ç…§è¾¨è­˜</button>
            </div>
        </div>

        <!-- è¾¨è­˜çµæœ -->
        <div id="result-area" class="mb-6">
            <h2 class="text-lg font-semibold mb-2 text-gray-700">è¾¨è­˜çµæœï¼š</h2>
            <div id="tags-container" class="flex flex-wrap gap-2">
                <span class="text-gray-400 italic">å°šæœªé€²è¡Œè¾¨è­˜</span>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="flex gap-4">
            <button id="detect-btn" onclick="detectObjects()" disabled class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 transition">
                ğŸ” é–‹å§‹è¾¨è­˜
            </button>
            <button onclick="resetAll()" class="w-1/4 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition">
                é‡ç½®
            </button>
        </div>
    </div>

    <script>
        let model = null;
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('output-canvas');
        const ctx = canvas.getContext('2d');
        const tagsContainer = document.getElementById('tags-container');
        const detectBtn = document.getElementById('detect-btn');
        const statusDiv = document.getElementById('status');
        const captureOverlay = document.getElementById('capture-overlay');
        
        let currentImage = null; // å­˜å„²ç›®å‰è¦è¾¨è­˜çš„åœ–åƒæº

        // ä¸­è‹±å°ç…§è¡¨
        const labelMap = {
            'person': 'äºº', 'bicycle': 'è‡ªè¡Œè»Š', 'car': 'æ±½è»Š', 'motorcycle': 'æ‘©æ‰˜è»Š', 'airplane': 'é£›æ©Ÿ',
            'bus': 'å·´å£«', 'train': 'ç«è»Š', 'truck': 'å¡è»Š', 'boat': 'èˆ¹', 'traffic light': 'ç´…ç¶ ç‡ˆ',
            'fire hydrant': 'æ¶ˆé˜²æ “', 'stop sign': 'åœæ­¢æ¨™èªŒ', 'parking meter': 'åœè»Šæ”¶è²»è¡¨', 'bench': 'é•·æ¤…',
            'bird': 'é³¥', 'cat': 'è²“', 'dog': 'ç‹—', 'horse': 'é¦¬', 'sheep': 'ç¾Š', 'cow': 'ä¹³ç‰›',
            'elephant': 'å¤§è±¡', 'bear': 'ç†Š', 'zebra': 'æ–‘é¦¬', 'giraffe': 'é•·é ¸é¹¿', 'backpack': 'èƒŒåŒ…',
            'umbrella': 'é›¨å‚˜', 'handbag': 'æ‰‹æåŒ…', 'tie': 'é ˜å¸¶', 'suitcase': 'è¡Œæç®±', 'frisbee': 'é£›ç›¤',
            'skis': 'æ»‘é›ªæ¿', 'snowboard': 'å–®æ¿æ»‘é›ª', 'sports ball': 'çƒ', 'kite': 'é¢¨ç®', 'baseball bat': 'çƒæ£’',
            'baseball glove': 'æ‰‹å¥—', 'skateboard': 'æ»‘æ¿', 'surfboard': 'è¡æµªæ¿', 'tennis racket': 'ç¶²çƒæ‹',
            'bottle': 'ç“¶å­', 'wine glass': 'é…’æ¯', 'cup': 'æ¯å­', 'fork': 'å‰å­', 'knife': 'åˆ€å­', 'spoon': 'æ¹¯åŒ™',
            'bowl': 'ç¢—', 'banana': 'é¦™è•‰', 'apple': 'è˜‹æœ', 'sandwich': 'ä¸‰æ˜æ²»', 'orange': 'æ©˜å­',
            'broccoli': 'èŠ±æ¤°èœ', 'carrot': 'ç´…è˜¿è””', 'hot dog': 'ç†±ç‹—', 'pizza': 'æŠ«è–©', 'donut': 'ç”œç”œåœˆ',
            'cake': 'è›‹ç³•', 'chair': 'æ¤…å­', 'couch': 'æ²™ç™¼', 'potted plant': 'ç›†æ ½', 'bed': 'åºŠ',
            'dining table': 'é¤æ¡Œ', 'toilet': 'é¦¬æ¡¶', 'tv': 'é›»è¦–', 'laptop': 'ç­†è¨˜å‹é›»è…¦', 'mouse': 'æ»‘é¼ ',
            'remote': 'é™æ§å™¨', 'keyboard': 'éµç›¤', 'cell phone': 'æ‰‹æ©Ÿ', 'microwave': 'å¾®æ³¢çˆ', 'oven': 'çƒ¤ç®±',
            'toaster': 'çƒ¤éºµåŒ…æ©Ÿ', 'sink': 'æ´—æ‰‹å°', 'refrigerator': 'å†°ç®±', 'book': 'æ›¸æœ¬', 'clock': 'æ™‚é˜',
            'vase': 'èŠ±ç“¶', 'scissors': 'å‰ªåˆ€', 'teddy bear': 'æ³°è¿ªç†Š', 'hair drier': 'å¹é¢¨æ©Ÿ', 'toothbrush': 'ç‰™åˆ·'
        };

        // 1. åˆå§‹åŒ–è¼‰å…¥æ¨¡å‹
        async function loadModel() {
            try {
                model = await cocoSsd.load();
                statusDiv.innerHTML = 'âœ… æ¨¡å‹è¼‰å…¥å®Œæˆï¼Œè«‹é¸æ“‡è¼¸å…¥æ–¹å¼';
                statusDiv.classList.replace('text-blue-600', 'text-green-600');
            } catch (error) {
                statusDiv.innerHTML = 'âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
            }
        }
        loadModel();

        // 2. è™•ç†æª”æ¡ˆä¸Šå‚³
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            resetUI();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    drawImageToCanvas(img);
                    currentImage = img;
                    detectBtn.disabled = false;
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        // 3. è™•ç†è¦–è¨Šé¡é ­
        async function startWebcam() {
            resetUI();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.style.display = 'block';
                canvas.style.display = 'none';
                captureOverlay.classList.remove('hidden');
            } catch (err) {
                alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ: ' + err.message);
            }
        }

        // 4. æ‹ç…§
        function captureImage() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            currentImage = new Image();
            currentImage.src = canvas.toDataURL('image/png');
            
            // åœæ­¢æ”å½±æ©Ÿ
            const stream = video.srcObject;
            stream.getTracks().forEach(track => track.stop());
            
            video.style.display = 'none';
            canvas.style.display = 'block';
            captureOverlay.classList.add('hidden');
            detectBtn.disabled = false;
        }

        function drawImageToCanvas(img) {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            canvas.style.display = 'block';
            video.style.display = 'none';
        }

        // 5. åŸ·è¡Œè¾¨è­˜
        async function detectObjects() {
            if (!model || !currentImage) return;

            detectBtn.innerText = 'è¾¨è­˜ä¸­...';
            detectBtn.disabled = true;
            tagsContainer.innerHTML = '';

            // åŸ·è¡Œè¾¨è­˜ (é€™è£¡å¯ä»¥è¼¸å…¥åœ–ç‰‡ã€å½±ç‰‡æˆ– Canvas)
            const predictions = await model.detect(canvas);

            // ç¹ªè£½çµæœ
            ctx.drawImage(currentImage, 0, 0); // é‡ç¹ªåº•åœ–
            ctx.font = '24px Arial';
            ctx.lineWidth = 4;

            if (predictions.length === 0) {
                tagsContainer.innerHTML = '<span class="text-red-500">æœªè¾¨è­˜å‡ºä»»ä½•ç‰©ä»¶</span>';
            }

            const detectedLabels = new Set();

            predictions.forEach(prediction => {
                const [x, y, width, height] = prediction.bbox;
                const labelEn = prediction.class;
                const labelZh = labelMap[labelEn] || labelEn;
                const score = Math.round(prediction.score * 100);

                // ç•«æ¡†
                ctx.strokeStyle = '#00FFFF';
                ctx.strokeRect(x, y, width, height);

                // ç•«æ¨™ç±¤èƒŒæ™¯
                ctx.fillStyle = '#00FFFF';
                ctx.fillRect(x, y - 30, ctx.measureText(labelZh).width + 60, 30);
                
                // å¯«å­—
                ctx.fillStyle = '#000000';
                ctx.fillText(`${labelZh} (${score}%)`, x, y - 5);

                detectedLabels.add(`${labelZh} / ${labelEn}`);
            });

            // é¡¯ç¤ºæ–‡å­—æ¨™ç±¤
            detectedLabels.forEach(label => {
                const span = document.createElement('span');
                span.className = 'bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-semibold border border-indigo-200';
                span.innerText = label;
                tagsContainer.appendChild(span);
            });

            detectBtn.innerText = 'é–‹å§‹è¾¨è­˜';
            detectBtn.disabled = false;
        }

        // é‡ç½® UI
        function resetUI() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            video.style.display = 'none';
            canvas.style.display = 'block';
            captureOverlay.classList.add('hidden');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            tagsContainer.innerHTML = '<span class="text-gray-400 italic">å°šæœªé€²è¡Œè¾¨è­˜</span>';
            detectBtn.disabled = true;
            currentImage = null;
        }

        function resetAll() {
            resetUI();
            document.getElementById('file-input').value = '';
        }
    </script>
</body>
</html>