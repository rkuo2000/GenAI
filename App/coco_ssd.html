<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 物件辨識系統</title>
    <!-- 載入 TensorFlow.js 和 COCO-SSD 模型 -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 600px; width: 100%; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        .preview-area { position: relative; margin: 20px 0; min-height: 200px; border: 2px dashed #ccc; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        canvas, video, img { max-width: 100%; height: auto; border-radius: 5px; }
        .controls, .actions { margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; background-color: #007bff; color: white; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .reset-btn { background-color: #dc3545; }
        .reset-btn:hover { background-color: #a71d2a; }
        #result { margin-top: 20px; text-align: left; }
        .item { background: #e9ecef; padding: 8px; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; }
        .loading-spinner { display: none; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h2>AI 物件辨識</h2>
    
    <!-- 選擇輸入方式 -->
    <div class="controls">
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
        <button onclick="document.getElementById('imageUpload').click()">上傳照片</button>
        <button id="webcamBtn">開啟攝影機</button>
    </div>

    <!-- 預覽區域 -->
    <div class="preview-area" id="previewArea">
        <p id="placeholderText">請選擇輸入方式</p>
        <video id="webcam" autoplay playsinline muted style="display:none;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="imagePreview" style="display:none;">
    </div>

    <!-- 操作按鍵 -->
    <div class="actions">
        <button id="captureBtn" style="display:none;">拍攝照片</button>
        <button id="detectBtn" disabled>開始辨識物件</button>
        <button class="reset-btn" onclick="resetApp()">重置</button>
    </div>

    <div class="loading-spinner" id="loader">模型載入中，請稍候...</div>

    <!-- 辨識結果 -->
    <div id="result"></div>
</div>

<script>
    const imageUpload = document.getElementById('imageUpload');
    const webcamBtn = document.getElementById('webcamBtn');
    const captureBtn = document.getElementById('captureBtn');
    const detectBtn = document.getElementById('detectBtn');
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const imagePreview = document.getElementById('imagePreview');
    const resultDiv = document.getElementById('result');
    const loader = document.getElementById('loader');
    const placeholderText = document.getElementById('placeholderText');

    let model = null;
    let stream = null;

    // 中英文對照表 (COCO Dataset 常用物件)
    const labelsCN = {
        "person": "人", "bicycle": "腳踏車", "car": "汽車", "motorcycle": "摩托車", "airplane": "飛機",
        "bus": "巴士", "train": "火車", "truck": "卡車", "boat": "船", "traffic light": "紅綠燈",
        "fire hydrant": "消防栓", "stop sign": "停止標誌", "parking meter": "停車收費表", "bench": "長椅",
        "bird": "鳥", "cat": "貓", "dog": "狗", "horse": "馬", "sheep": "羊", "cow": "牛",
        "elephant": "大象", "bear": "熊", "zebra": "斑馬", "giraffe": "長頸鹿", "backpack": "背包",
        "umbrella": "雨傘", "handbag": "手提包", "tie": "領帶", "suitcase": "行李箱", "frisbee": "飛盤",
        "skis": "滑雪板", "snowboard": "滑雪板", "sports ball": "運動球類", "kite": "風箏", "baseball bat": "棒球棒",
        "baseball glove": "棒球手套", "skateboard": "滑板", "surfboard": "衝浪板", "tennis racket": "網球拍",
        "bottle": "瓶子", "wine glass": "酒杯", "cup": "杯子", "fork": "叉子", "knife": "刀子", "spoon": "湯勺",
        "bowl": "碗", "banana": "香蕉", "apple": "蘋果", "sandwich": "三明治", "orange": "橘子",
        "broccoli": "花椰菜", "carrot": "胡蘿蔔", "hot dog": "熱狗", "pizza": "披薩", "donut": "甜甜圈",
        "cake": "蛋糕", "chair": "椅子", "couch": "沙發", "potted plant": "盆栽", "bed": "床",
        "dining table": "餐桌", "toilet": "馬桶", "tv": "電視", "laptop": "筆電", "mouse": "滑鼠",
        "remote": "遙控器", "keyboard": "鍵盤", "cell phone": "手機", "microwave": "微波爐", "oven": "烤箱",
        "toaster": "烤麵包機", "sink": "水槽", "refrigerator": "冰箱", "book": "書", "clock": "時鐘",
        "vase": "花瓶", "scissors": "剪刀", "teddy bear": "泰迪熊", "hair drier": "吹風機", "toothbrush": "牙刷"
    };

    // 初始化載入模型
    async function loadModel() {
        loader.style.display = 'block';
        model = await cocoSsd.load();
        loader.style.display = 'none';
        console.log("Model loaded.");
    }
    loadModel();

    // 處理上傳圖片
    imageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            stopWebcam();
            const reader = new FileReader();
            reader.onload = (event) => {
                imagePreview.src = event.target.result;
                imagePreview.style.display = 'block';
                canvas.style.display = 'none';
                webcam.style.display = 'none';
                placeholderText.style.display = 'none';
                detectBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }
    });

    // 開啟 Webcam
    webcamBtn.addEventListener('click', async () => {
        imagePreview.style.display = 'none';
        placeholderText.style.display = 'none';
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            webcam.srcObject = stream;
            webcam.style.display = 'block';
            captureBtn.style.display = 'inline-block';
            detectBtn.disabled = true;
        } catch (err) {
            alert("無法存取攝影機: " + err);
        }
    });

    // 拍攝照片
    captureBtn.addEventListener('click', () => {
        const ctx = canvas.getContext('2d');
        canvas.width = webcam.videoWidth;
        canvas.height = webcam.videoHeight;
        ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);
        
        imagePreview.src = canvas.toDataURL('image/png');
        imagePreview.style.display = 'block';
        webcam.style.display = 'none';
        captureBtn.style.display = 'none';
        detectBtn.disabled = false;
        stopWebcam();
    });

    // 停止視訊串流
    function stopWebcam() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    // 進行物件辨識
    detectBtn.addEventListener('click', async () => {
        if (!model) return alert("模型尚未就緒");

        resultDiv.innerHTML = "辨識中...";
        const predictions = await model.detect(imagePreview);
        
        drawResult(predictions);
    });

    // 繪製結果與顯示文字
    function drawResult(predictions) {
        resultDiv.innerHTML = "<h3>辨識結果：</h3>";
        
        if (predictions.length === 0) {
            resultDiv.innerHTML += "<p>未偵測到任何物件</p>";
            return;
        }

        // 在 Canvas 上繪製框線
        const ctx = canvas.getContext('2d');
        canvas.width = imagePreview.naturalWidth;
        canvas.height = imagePreview.naturalHeight;
        ctx.drawImage(imagePreview, 0, 0);
        
        predictions.forEach(prediction => {
            const [x, y, width, height] = prediction.bbox;
            const englishName = prediction.class;
            const chineseName = labelsCN[englishName] || "未知物件";
            const score = Math.round(prediction.score * 100);

            // 畫框
            ctx.strokeStyle = "#00FF00";
            ctx.lineWidth = 4;
            ctx.strokeRect(x, y, width, height);

            // 畫標籤背景
            ctx.fillStyle = "#00FF00";
            ctx.fillRect(x, y - 25, width, 25);
            ctx.fillStyle = "#000000";
            ctx.font = "18px Arial";
            ctx.fillText(`${chineseName} (${score}%)`, x, y - 5);

            // 顯示文字列表
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            itemDiv.innerHTML = `<span><strong>${chineseName}</strong> <small>(${englishName})</small></span> <span>信心度: ${score}%</span>`;
            resultDiv.appendChild(itemDiv);
        });

        // 更新預覽圖為帶有框線的照片
        imagePreview.src = canvas.toDataURL();
    }

    // 重置功能
    function resetApp() {
        stopWebcam();
        imageUpload.value = "";
        imagePreview.style.display = 'none';
        imagePreview.src = "";
        webcam.style.display = 'none';
        canvas.style.display = 'none';
        captureBtn.style.display = 'none';
        detectBtn.disabled = true;
        resultDiv.innerHTML = "";
        placeholderText.style.display = 'block';
    }
</script>

</body>
</html>