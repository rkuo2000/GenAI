<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•¢æ¥­å°ˆé¡Œ: gm/Id é«˜å¢ç›ŠäºŒéšæ”¾å¤§å™¨è¨­è¨ˆ | High-Gain Op-Amp Designer</title>
    <style>
        :root {
            --primary: #00ff88;
            --primary-dim: #00cc6a;
            --accent: #2e9cdb;
            --bg-dark: #0f1115;
            --bg-card: #161b22;
            --text-main: #e6edf3;
            --text-sub: #8b949e;
            --border: #30363d;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0, 255, 136, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(46, 156, 219, 0.05) 0%, transparent 40%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 2rem;
        }

        header h1 {
            font-size: 2.2rem;
            margin: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        header p {
            color: var(--text-sub);
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .badge {
            display: inline-block;
            background: rgba(46, 156, 219, 0.2);
            color: var(--accent);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 2rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        h2 {
            margin-top: 0;
            font-size: 1.3rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.8rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }

        .input-group {
            margin-bottom: 1.2rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.4rem;
            color: var(--text-sub);
            font-size: 0.85rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        input {
            width: 100%;
            background: #0d1117;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.6rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dim) 100%);
            color: #000;
            border: none;
            padding: 0.8rem;
            border-radius: 6px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-top: 1rem;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.95rem;
        }

        .result-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-weight: 600;
        }

        .visual-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-sub);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .tab-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(0, 255, 136, 0.1);
        }

        /* SVG */
        .schematic-svg {
            width: 100%;
            height: auto;
            max-height: 350px;
        }

        .net {
            stroke: var(--text-main);
            stroke-width: 2;
            fill: none;
        }

        .comp {
            stroke: var(--accent);
            stroke-width: 2;
            fill: none;
        }

        .text {
            fill: var(--text-main);
            font-family: sans-serif;
            font-size: 11px;
        }

        .hl-p {
            fill: rgba(46, 156, 219, 0.1);
            stroke: none;
        }

        .hl-n {
            fill: rgba(0, 255, 136, 0.1);
            stroke: none;
        }

        .theory-note {
            background: rgba(46, 156, 219, 0.1);
            border: 1px solid rgba(46, 156, 219, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>åŸºæ–¼ gm/Id æ³•ä¹‹é«˜å¢ç›Š CMOS é‹ç®—æ”¾å¤§å™¨</h1>
            <p>TSMC 0.18Âµm Process | PMOS Input Stage | Miller Compensation</p>
            <div class="badge">ç•¢æ¥­å°ˆé¡Œè¼”åŠ©å·¥å…·</div>
        </header>

        <div class="grid">
            <!-- Input Section -->
            <div class="card">
                <h2>âš™ï¸ è¨­è¨ˆè¦æ ¼èˆ‡åƒæ•¸ (Specs)</h2>
                <form id="designForm">
                    <!-- Process Specs -->
                    <div class="input-group">
                        <label>è£½ç¨‹åƒæ•¸ (TSMC 0.18Âµm Model)</label>
                        <div class="input-row">
                            <div>
                                <label>Kn' (ÂµA/VÂ²)</label>
                                <input type="number" id="kn" value="170">
                            </div>
                            <div>
                                <label>Kp' (ÂµA/VÂ²)</label>
                                <input type="number" id="kp" value="40">
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>é›»æºé›»å£“ VDD (V)</label>
                        <input type="number" id="vdd" value="3.3" step="0.1">
                    </div>

                    <!-- Design Specs from Report -->
                    <div class="input-group">
                        <label>ç›®æ¨™è¦æ ¼ (Target Specifications)</label>
                        <div class="input-row">
                            <div>
                                <label>DC Gain (dB)</label>
                                <input type="number" id="gainDb" value="85"> <!-- Report avg 85.73 -->
                            </div>
                            <div>
                                <label>GBW (MHz)</label>
                                <input type="number" id="gbw" value="11"> <!-- Report avg 11.14 -->
                            </div>
                        </div>
                        <div class="input-row" style="margin-top: 0.5rem">
                            <div>
                                <label>Phase Margin (Â°)</label>
                                <input type="number" id="pm" value="55"> <!-- Report 54.52 -->
                            </div>
                            <div>
                                <label>Slew Rate (V/Âµs)</label>
                                <input type="number" id="sr" value="10"> <!-- Report 10.59 -->
                            </div>
                        </div>
                        <div class="input-row" style="margin-top: 0.5rem">
                            <div>
                                <label>Load Cap CL (pF)</label>
                                <input type="number" id="cl" value="5">
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn" onclick="calculate()">åŸ·è¡Œé‹ç®—/æœ€ä½³åŒ–</button>
                </form>
            </div>

            <!-- Visual & Results -->
            <div>
                <div class="card" style="margin-bottom: 2rem;">
                    <div class="visual-tabs">
                        <button class="tab-btn active" onclick="showTab('schematic')">é›»è·¯æ¶æ§‹ (Schematic)</button>
                        <button class="tab-btn" onclick="showTab('bode')">é »ç‡éŸ¿æ‡‰ (Bode)</button>
                    </div>

                    <!-- Schematic View -->
                    <div id="visual-schematic">
                        <svg viewBox="0 0 400 320" class="schematic-svg">
                            <!-- Highlighting Blocks -->
                            <rect x="20" y="40" width="160" height="240" rx="8" class="hl-p" />
                            <text x="30" y="60" class="text" style="fill: var(--accent); font-weight:bold;">Stage 1:
                                PMOS Diff Pair</text>

                            <rect x="200" y="40" width="180" height="240" rx="8" class="hl-n" />
                            <text x="210" y="60" class="text" style="fill: var(--primary); font-weight:bold;">Stage 2:
                                NMOS CS</text>

                            <!-- POWER RAILS -->
                            <line x1="50" y1="20" x2="350" y2="20" class="net"
                                style="stroke-width:1; stroke-dasharray:4;" />
                            <text x="10" y="25" class="text">VDD (3.3V)</text>
                            <line x1="50" y1="300" x2="350" y2="300" class="net"
                                style="stroke-width:1; stroke-dasharray:4;" />
                            <text x="10" y="305" class="text">VSS (GND)</text>

                            <!-- STAGE 1: PMOS INPUT -->
                            <!-- Tail Current Source (Top) -->
                            <circle cx="100" cy="50" r="3" fill="#fff" />
                            <path d="M 100,20 L 100,70" class="net" /> <!-- VDD to Tail -->
                            <rect x="90" y="40" width="20" height="20" class="comp" /> <!-- Symbol for Ib bias -->
                            <text x="115" y="55" class="text">Ib1</text>

                            <!-- Diff Pair Sources -->
                            <path d="M 100,70 L 70,70 L 70,90" class="net" />
                            <path d="M 100,70 L 130,70 L 130,90" class="net" />

                            <!-- M1 (PMOS) Left -->
                            <circle cx="70" cy="95" r="2" class="comp" /> <!-- PMOS bubble -->
                            <path d="M 70,97 L 70,120" class="comp" />
                            <path d="M 60,105 L 60,115" class="comp" /> <!-- Gate -->
                            <path d="M 60,110 L 40,110" class="net" /> <!-- Vin+ -->
                            <text x="20" y="115" class="text">Vin+</text>

                            <!-- M2 (PMOS) Right -->
                            <circle cx="130" cy="95" r="2" class="comp" /> <!-- PMOS bubble -->
                            <path d="M 130,97 L 130,120" class="comp" />
                            <path d="M 140,105 L 140,115" class="comp" /> <!-- Gate -->
                            <path d="M 140,110 L 160,110" class="net" /> <!-- Vin- -->
                            <text x="165" y="115" class="text">Vin-</text>

                            <!-- Active Load (NMOS Mirror) Bottom -->
                            <path d="M 70,120 L 70,200" class="net" />
                            <path d="M 130,120 L 130,200" class="net" />

                            <!-- M3 (NMOS Diode) Left -->
                            <path d="M 70,200 L 70,230" class="comp" />
                            <path d="M 60,210 L 60,220" class="comp" /> <!-- Gate -->
                            <path d="M 70,230 L 70,300" class="net" /> <!-- to VSS -->
                            <path d="M 60,215 L 70,215" class="net" /> <!-- Diode connect -->

                            <!-- M4 (NMOS) Right -->
                            <path d="M 130,200 L 130,230" class="comp" />
                            <path d="M 120,210 L 120,220" class="comp" /> <!-- Gate -->
                            <path d="M 60,215 L 120,215" class="net" /> <!-- Mirror connection -->
                            <path d="M 130,230 L 130,300" class="net" /> <!-- to VSS -->

                            <!-- STAGE 2: NMOS CS -->
                            <!-- Input from Stage 1 out (Drain M2/M4) -->
                            <circle cx="130" cy="160" r="2" fill="#fff" />
                            <path d="M 130,160 L 250,160" class="net" />

                            <!-- M7 (NMOS CS) -->
                            <path d="M 260,190 L 260,230" class="comp" />
                            <path d="M 250,200 L 250,220" class="comp" /> <!-- Gate -->
                            <path d="M 250,160 L 250,210" class="net" /> <!-- Gate connection -->
                            <path d="M 260,230 L 260,300" class="net" /> <!-- to VSS -->

                            <!-- Active Load M6/Bias (PMOS) Top -->
                            <path d="M 260,20 L 260,100" class="net" />
                            <circle cx="260" cy="105" r="2" class="comp" /> <!-- PMOS bubble -->
                            <path d="M 260,107 L 260,140" class="comp" />
                            <path d="M 250,120 L 250,130" class="comp" /> <!-- Gate -->
                            <text x="270" y="80" class="text">PMOS Load</text>

                            <!-- Output Node -->
                            <path d="M 260,140 L 260,190" class="net" />
                            <circle cx="260" cy="165" r="3" fill="#ff0000" />
                            <line x1="260" y1="165" x2="320" y2="165" class="net" />
                            <text x="330" y="170" class="text" style="font-weight:bold; fill:#fff;">Vout</text>

                            <!-- Miller Cap Cc -->
                            <path d="M 150,160 L 150,120 L 210,120" class="net" style="stroke-dasharray: 2;" />
                            <line x1="210" y1="110" x2="210" y2="130" class="comp" />
                            <line x1="220" y1="110" x2="220" y2="130" class="comp" />
                            <path d="M 220,120 L 260,120 L 260,140" class="net" style="stroke-dasharray: 2;" />
                            <text x="170" y="110" class="text" style="fill: #00ff88;">Cc</text>

                            <text x="270" y="210" class="text">M_CS (NMOS)</text>
                        </svg>

                        <div class="theory-note">
                            <h3 style="margin:0 0 0.5rem 0; color: var(--accent); font-size:1rem;">ğŸ“˜ é—œæ–¼æ­¤å°ˆé¡Œæ¶æ§‹
                                (Architecture Note)</h3>
                            <p style="margin:0; color: var(--text-sub);">
                                æœ¬è¨­è¨ˆæ¡ç”¨ **PMOS å·®å‹•è¼¸å…¥ç´š** (Stage 1)ï¼Œå…¶å„ªé»åœ¨æ–¼ PMOS ä¹‹ 1/f é›œè¨Š (Flicker Noise) è¼ƒä½ï¼Œé©åˆé«˜ç²¾å¯†é¡æ¯”é›»è·¯ã€‚
                                ç¬¬äºŒç´šç‚ºäº’è£œçš„ **NMOS å…±æºæ¥µæ”¾å¤§å™¨** (Common Source)ã€‚
                                <br><br>
                                è¨­è¨ˆæ–¹æ³•æ¡ç”¨ç¾ä»£çš„ **gm/Id æ–¹æ³•å­¸** (è€Œéå‚³çµ±å¹³æ–¹å¾‹)ï¼Œé€éæ§åˆ¶æ“ä½œå€é–“ (Inversion Level) ä¾†ç²å¾—æœ€ä½³çš„è½‰å°æ•ˆç‡èˆ‡é »å¯¬å¹³è¡¡ã€‚
                            </p>
                        </div>
                    </div>

                    <!-- Bode View -->
                    <div id="visual-bode" style="display:none;">
                        <canvas id="bodeChart"></canvas>
                    </div>
                </div>

                <!-- Calculated Results -->
                <div class="card">
                    <h2>ğŸ“Š è¨ˆç®—çµæœ (Results)</h2>
                    <div id="results"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let myChart = null;

        function showTab(id) {
            document.getElementById('visual-schematic').style.display = id === 'schematic' ? 'block' : 'none';
            document.getElementById('visual-bode').style.display = id === 'bode' ? 'block' : 'none';

            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (id === 'bode' && !myChart) calculate();
        }

        // Main Design Logic
        function calculate() {
            // 1. Fetch Inputs
            const Kn_prime = parseFloat(document.getElementById('kn').value) * 1e-6;
            const Kp_prime = parseFloat(document.getElementById('kp').value) * 1e-6;
            const Vdd = parseFloat(document.getElementById('vdd').value);
            const Gain_dB = parseFloat(document.getElementById('gainDb').value);
            const GBW = parseFloat(document.getElementById('gbw').value) * 1e6;
            const PM = parseFloat(document.getElementById('pm').value);
            const SR = parseFloat(document.getElementById('sr').value) * 1e6;
            const CL = parseFloat(document.getElementById('cl').value) * 1e-12;

            // 2. Calculation Steps based on Square Law (Simplified for Web Tool)
            // Note: Real gm/Id method requires Look-up Tables (LUT) from simulation data.
            // We will approximate using Square Law but mention the logic.

            // Step A: Miller Compensation Cap (Cc)
            // To ensure pole splitting and PM, typical rule: Cc > 0.22 * CL
            // Report used significant Cc to get 55 deg.
            // Let's assume we place non-dominant pole at > 2 * GBW (approx).
            // For educational display:
            let Cc = 0.3 * CL;
            if (Cc < 1e-12) Cc = 1e-12;

            // Step B: Bias Current (Iss) and Slew Rate
            // SR = Iss / Cc => Iss = SR * Cc
            let Iss = SR * Cc;

            // Step C: Stage 1 Transconductance (gm1) - PMOS Input Pair
            // GBW = gm1 / (2 * pi * Cc)
            let gm1 = GBW * 2 * Math.PI * Cc;

            // Verify stability requirement roughly: gm2 >> gm1 usually

            // Step D: Stage 1 Sizing (W/L)1 (PMOS)
            // Using PMOS Kp': gm1 = sqrt(2 * Kp' * (W/L)1 * (Iss/2))
            // (W/L)1 = gm1^2 / (Kp' * Iss)
            let WL1 = (gm1 * gm1) / (Kp_prime * Iss);

            // Step E: Stage 2 Transconductance (gm2) - NMOS CS
            // Non-dominant pole p2 ~= gm2 / CL
            // For PM=60, we need p2 ~= 2.2 * GBW (Tan(60) factor approx)
            // Let's target p2 = 3 * GBW to be safe for >55 deg
            let omega_p2 = 3 * (2 * Math.PI * GBW);
            let gm2 = omega_p2 * CL;

            // Step F: Stage 2 Current & Sizing (NMOS)
            // Assume Vov2 ~ 0.2V (Common choice)
            // Id2 = 0.5 * gm2 * Vov2
            let Vov2 = 0.25;
            let Id2 = 0.5 * gm2 * Vov2;

            // (W/L)2 (NMOS) using Kn'
            // gm2 = sqrt(2 * Kn' * (W/L)2 * Id2)
            // (W/L)2 = gm2^2 / (2 * Kn' * Id2)
            let WL2 = (gm2 * gm2) / (2 * Kn_prime * Id2);

            // Render HTML
            const html = `
            <div class="result-item">
                <span style="color:var(--text-sub)">Miller Cap (Cc)</span>
                <span class="result-value">${(Cc * 1e12).toFixed(2)} pF</span>
            </div>
            <div class="result-item">
                <span style="color:var(--text-sub)">Bias Current (Iss)</span>
                <span class="result-value">${(Iss * 1e6).toFixed(2)} ÂµA</span>
            </div>
            <div class="result-item">
                <span style="color:var(--text-sub)">Stage 1 (PMOS) gm1</span>
                <span class="result-value">${(gm1 * 1000).toFixed(2)} mS</span>
            </div>
            <div class="result-item">
                <span style="color:var(--accent)">Stage 1 (W/L)â‚</span>
                <span class="result-value">${WL1.toFixed(1)}</span>
            </div>
            <hr style="border:0; border-top:1px solid #333; margin:1rem 0;">
            <div class="result-item">
                <span style="color:var(--text-sub)">Stage 2 (NMOS) gm2</span>
                <span class="result-value">${(gm2 * 1000).toFixed(2)} mS</span>
            </div>
            <div class="result-item">
                <span style="color:var(--text-sub)">Stage 2 Current (Id2)</span>
                <span class="result-value">${(Id2 * 1e6).toFixed(2)} ÂµA</span>
            </div>
            <div class="result-item">
                <span style="color:var(--primary)">Stage 2 (W/L)â‚‚</span>
                <span class="result-value">${WL2.toFixed(1)}</span>
            </div>
            <div class="result-item" style="margin-top:0.5rem">
                <span style="color:var(--text-sub)">Total Power</span>
                <span class="result-value">${((Iss + Id2) * Vdd * 1000).toFixed(2)} mW</span>
            </div>
        `;
            document.getElementById('results').innerHTML = html;

            updateChart(Gain_dB, GBW);
        }

        function updateChart(gain, gbw) {
            const ctx = document.getElementById('bodeChart').getContext('2d');
            const p1 = gbw / Math.pow(10, gain / 20);

            if (myChart) myChart.destroy();

            // Simplified data generation
            const pts = [];
            const labels = [];
            for (let f = 100; f < gbw * 50; f *= 2.5) {
                let val = 20 * Math.log10(Math.pow(10, gain / 20) / Math.sqrt(1 + (f / p1) ** 2));
                pts.push(val);
                labels.push(f < 1e6 ? (f / 1000).toFixed(0) + 'k' : (f / 1e6).toFixed(1) + 'M');
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gain (dB)',
                        data: pts,
                        borderColor: '#2e9cdb',
                        backgroundColor: 'rgba(46, 156, 219, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
                        x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Init
        calculate();
    </script>
</body>

</html>